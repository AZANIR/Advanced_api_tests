# ============================================================================
# Test and Deploy to GitHub Pages
# ============================================================================
# Простий workflow для запуску тестів з jest-axios-framework та публікації
# результатів на GitHub Pages.
#
# Що робить цей workflow:
# 1. Переходить в папку jest-axios-framework
# 2. Встановлює залежності
# 3. Запускає тести з покриттям коду
# 4. Зберігає HTML звіти як артефакти
# 5. Автоматично публікує звіти на GitHub Pages (тільки для main branch)
#
# ВАЖЛИВО: Для роботи GitHub Pages потрібно:
# 1. Увімкнути GitHub Pages в Settings → Pages → Source: "GitHub Actions"
# 2. Workflow автоматично деплоїть звіти після успішного завершення тестів
# ============================================================================

name: Test and Deploy to GitHub Pages

# Тригери для запуску workflow
on:
  # Запуск при push в main branch
  push:
    branches: [main, develop, master]
  # Запуск при створенні/оновленні PR в main branch
  pull_request:
    branches: [main, develop, master]
  # Дозволяє запускати workflow вручну через GitHub Actions UI
  workflow_dispatch:

jobs:
  # ========================================================================
  # Job: Запуск тестів
  # ========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      # Крок 1: Отримання коду з репозиторію
      - name: Checkout code
        uses: actions/checkout@v4

      # Крок 2: Налаштування Node.js з кешуванням залежностей
      # Примітка: cache-dependency-path не вказується, оскільки package-lock.json в .gitignore
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18" # Версія Node.js для запуску тестів
          cache: "npm" # Кешування node_modules для прискорення збірки
          cache-dependency-path: jest-axios-framework/package.json

      # Крок 3: Перехід в папку фреймворку та встановлення залежностей
      # Використовується npm install замість npm ci, оскільки package-lock.json в .gitignore
      # npm install працює без package-lock.json, генеруючи його автоматично
      - name: Install dependencies
        working-directory: jest-axios-framework
        run: npm install

      # Крок 4: Запуск тестів з покриттям коду
      # Змінні середовища встановлюються для правильної конфігурації репортерів та API
      - name: Run tests with coverage
        working-directory: jest-axios-framework
        run: npm run test:coverage
        env:
          CI: true # Вказує що запуск в CI середовищі
          GITHUB_ACTIONS: true # Дозволяє репортерам визначити GitHub Actions
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
          BASE_URL: https://jsonplaceholder.typicode.com
          REQRES_BASE_URL: https://reqres.in/api
          PETSTORE_BASE_URL: https://petstore.swagger.io/v2
          REQUEST_TIMEOUT: 10000
          ENVIRONMENT: dev

      # Крок 5: Збереження HTML звіту як артефакт
      # if: always() - зберігає артефакт навіть якщо тести провалилися
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: jest-axios-framework/reports/html/**
          retention-days: 30 # Зберігати артефакт 30 днів

      # Крок 6: Збереження JUnit XML звіту для інтеграції з CI системами
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: jest-axios-framework/reports/junit/**
          retention-days: 30

      # Крок 7: Збереження звіту про покриття коду
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: jest-axios-framework/reports/coverage/**
          retention-days: 30

  # ========================================================================
  # Job: Деплой HTML звітів на GitHub Pages
  # ========================================================================
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    # Запускається завжди після тестів, навіть якщо вони провалилися
    needs: test
    if: |
      always() &&
      (github.ref == 'refs/heads/main' || 
       github.ref == 'refs/heads/develop' || 
       github.ref == 'refs/heads/master') && 
      github.event_name == 'push'

    # Необхідні permissions для публікації на GitHub Pages
    permissions:
      contents: read # Читання коду
      pages: write # Запис на GitHub Pages
      id-token: write # Для OIDC автентифікації

    # Налаштування середовища для GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      # Крок 1: Отримання коду
      - name: Checkout code
        uses: actions/checkout@v4

      # Крок 2: Завантаження HTML звіту з артефактів попереднього job
      - name: Download HTML report
        uses: actions/download-artifact@v4
        with:
          name: html-report
          path: reports/html

      # Крок 3: Налаштування GitHub Pages
      # Конфігурує середовище для публікації на Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Крок 4: Підготовка файлів для GitHub Pages
      # jest-html-reporters генерує report.html або report-{timestamp}.html
      # GitHub Pages потребує index.html як стартову сторінку
      - name: Prepare site for GitHub Pages
        run: |
          # Створюємо директорію для GitHub Pages
          mkdir -p _site

          # Копіюємо всі файли HTML звіту (включаючи CSS, JS, дані)
          if [ -d "reports/html" ]; then
            cp -r reports/html/* _site/ || true
          fi

          # Знаходимо останній згенерований звіт та створюємо index.html
          # jest-html-reporters в CI генерує report-{timestamp}.html
          if [ -f "_site/report.html" ]; then
            # Якщо є простий report.html - використовуємо його
            cp _site/report.html _site/index.html
          else
            # Якщо є файли з timestamp (report-*.html), беремо останній
            LATEST_REPORT=$(ls -t _site/report-*.html 2>/dev/null | head -1)
            if [ -n "$LATEST_REPORT" ]; then
              cp "$LATEST_REPORT" _site/index.html
            fi
          fi

      # Крок 5: Завантаження артефакту для GitHub Pages
      # Створює артефакт з директорії _site для публікації
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      # Крок 6: Деплой на GitHub Pages
      # Публікує артефакт на GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
