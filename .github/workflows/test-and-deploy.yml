# ============================================================================
# Test and Deploy to GitHub Pages
# ============================================================================
# Простий workflow для запуску тестів з jest-axios-framework та публікації
# результатів на GitHub Pages.
#
# Що робить цей workflow:
# 1. Переходить в папку jest-axios-framework
# 2. Встановлює залежності
# 3. Запускає тести з покриттям коду
# 4. Зберігає HTML звіти як артефакти
# 5. Автоматично публікує звіти на GitHub Pages (тільки для main branch)
#
# ВАЖЛИВО: Для роботи GitHub Pages потрібно:
# 1. Увімкнути GitHub Pages в Settings → Pages → Source: "GitHub Actions"
# 2. Workflow автоматично деплоїть звіти після успішного завершення тестів
# ============================================================================

name: Test and Deploy to GitHub Pages

# Тригери для запуску workflow
on:
  # Запуск при push в main branch
  push:
    branches: [main, develop, master]
  # Запуск при створенні/оновленні PR в main branch
  pull_request:
    branches: [main, develop, master]
  # Дозволяє запускати workflow вручну через GitHub Actions UI
  workflow_dispatch:

jobs:
  # ========================================================================
  # Job: Запуск тестів
  # ========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    # Необхідні permissions для публікації на GitHub Pages
    permissions:
      contents: read # Читання коду
      pages: write # Запис на GitHub Pages
      id-token: write # Для OIDC автентифікації

    steps:
      # Крок 1: Отримання коду з репозиторію
      - name: Checkout code
        uses: actions/checkout@v4

      # Крок 2: Налаштування Node.js з кешуванням залежностей
      # Примітка: cache-dependency-path не вказується, оскільки package-lock.json в .gitignore
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18" # Версія Node.js для запуску тестів
          cache: "npm" # Кешування node_modules для прискорення збірки
          cache-dependency-path: jest-axios-framework/package.json

      # Крок 3: Перехід в папку фреймворку та встановлення залежностей
      # Використовується npm install замість npm ci, оскільки package-lock.json в .gitignore
      # npm install працює без package-lock.json, генеруючи його автоматично
      - name: Install dependencies
        working-directory: jest-axios-framework
        run: npm install

      # Крок 4: Запуск тестів з покриттям коду
      # Змінні середовища встановлюються для правильної конфігурації репортерів та API
      - name: Run tests with coverage
        working-directory: jest-axios-framework
        run: npm run test:coverage
        env:
          CI: true # Вказує що запуск в CI середовищі
          GITHUB_ACTIONS: true # Дозволяє репортерам визначити GitHub Actions
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
          API_KEY: ${{ secrets.API_KEY }}
          BASE_URL: https://jsonplaceholder.typicode.com
          REQRES_BASE_URL: https://reqres.in/api
          PETSTORE_BASE_URL: https://petstore.swagger.io/v2
          REQUEST_TIMEOUT: 10000
          ENVIRONMENT: dev

      # Крок 5: Збереження HTML звіту як артефакт
      # if: always() - зберігає артефакт навіть якщо тести провалилися
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report
          path: jest-axios-framework/reports/html/**
          retention-days: 30 # Зберігати артефакт 30 днів

      # Крок 6: Збереження JUnit XML звіту для інтеграції з CI системами
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: jest-axios-framework/reports/junit/**
          retention-days: 30

      # Крок 7: Збереження звіту про покриття коду
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: jest-axios-framework/reports/coverage/**
          retention-days: 30

      - name: Deploy to pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.ACCESS_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./jest-axios-framework/reports/html/
