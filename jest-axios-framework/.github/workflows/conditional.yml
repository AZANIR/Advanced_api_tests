# ============================================================================
# CI - Conditional Tests
# ============================================================================
# Умовний CI workflow, який запускає тести тільки при зміні релевантних файлів.
# 
# Переваги:
# - Економить час та ресурси CI
# - Запускає тести тільки коли це необхідно
# - Показує повідомлення якщо тести пропущені
# 
# Тести запускаються якщо змінені:
# - Файли в tests/** (тестові файли)
# - Файли в src/** (вихідний код)
# - jest.config.js або package.json (конфігурація)
# ============================================================================

name: CI - Conditional Tests

# Тригери для запуску workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ========================================================================
  # Job: Визначення змін у файлах
  # ========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    # Виводить результати для використання в наступних jobs
    outputs:
      tests: ${{ steps.filter.outputs.tests }}    # true якщо змінені тести
      src: ${{ steps.filter.outputs.src }}        # true якщо змінений код
      config: ${{ steps.filter.outputs.config }}  # true якщо змінена конфігурація
    
    steps:
      # Крок 1: Отримання коду
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Крок 2: Визначення змінених файлів
      # Використовує dorny/paths-filter для визначення змін
      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          # Фільтри для різних типів файлів
          filters: |
            tests:
              - 'tests/**'        # Всі файли в директорії tests
            src:
              - 'src/**'          # Всі файли в директорії src
            config:
              - 'jest.config.js'  # Конфігурація Jest
              - 'package.json'    # Залежності та скрипти

  # ========================================================================
  # Job: Запуск тестів (тільки якщо є релевантні зміни)
  # ========================================================================
  run-tests:
    name: Run Tests (Conditional)
    runs-on: ubuntu-latest
    # Запускається тільки після detect-changes
    needs: detect-changes
    # Умова: запускати тільки якщо змінені тести, код або конфігурація
    if: needs.detect-changes.outputs.tests == 'true' || needs.detect-changes.outputs.src == 'true' || needs.detect-changes.outputs.config == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # npm ci використовується для надійної збірки в CI
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      # Збереження звітів
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conditional-test-results
          path: reports/**

  # ========================================================================
  # Job: Повідомлення про пропуск тестів
  # ========================================================================
  skip-notification:
    name: Skip Notification
    runs-on: ubuntu-latest
    needs: detect-changes
    # Запускається тільки якщо НЕ було релевантних змін
    if: needs.detect-changes.outputs.tests != 'true' && needs.detect-changes.outputs.src != 'true' && needs.detect-changes.outputs.config != 'true'
    
    steps:
      # Виводить повідомлення в GitHub Actions summary
      - name: Skip message
        run: |
          echo "## Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "No relevant changes detected. Tests skipped." >> $GITHUB_STEP_SUMMARY
