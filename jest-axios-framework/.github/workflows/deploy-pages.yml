# ============================================================================
# Deploy Reports to GitHub Pages
# ============================================================================
# Простий workflow для публікації HTML звітів на GitHub Pages.
# Запускається автоматично після успішного завершення інших workflow.
# 
# ВАЖЛИВО: Для роботи цього workflow потрібно:
# 1. Увімкнути GitHub Pages в Settings → Pages → Source: "GitHub Actions"
# 2. Інші workflow повинні завантажувати HTML звіти як артефакт з ім'ям "html-report"
# ============================================================================

name: Deploy Reports to GitHub Pages

# Запускається після завершення інших workflow
on:
  workflow_run:
    # Список workflow, після яких запускати деплой
    workflows: ["CI - Basic Tests", "Full Pipeline - Tests + Deploy"]
    types:
      - completed  # Запускається після завершення (успішного або невдалого)

jobs:
  # ========================================================================
  # Job: Деплой HTML звітів на GitHub Pages
  # ========================================================================
  deploy:
    name: Deploy Reports
    runs-on: ubuntu-latest
    # Запускається тільки якщо попередній workflow завершився успішно
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    # Необхідні permissions для публікації на GitHub Pages
    permissions:
      contents: read    # Читання коду
      pages: write      # Запис на GitHub Pages
      id-token: write  # Для OIDC автентифікації
    
    steps:
      # Крок 1: Отримання коду з репозиторію
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Крок 2: Завантаження HTML звіту з артефактів попереднього workflow
      # Важливо: артефакт повинен мати ім'я "html-report"
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: html-report
          path: reports/html
          # Необхідно вказати токен та ID запуску для доступу до артефактів
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
      
      # Крок 3: Налаштування GitHub Pages
      # Конфігурує середовище для публікації на Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      # Крок 4: Підготовка файлів для GitHub Pages
      # jest-html-reporters генерує report.html або report-{timestamp}.html
      # GitHub Pages потребує index.html як стартову сторінку
      - name: Prepare site for GitHub Pages
        run: |
          # Створюємо директорію для GitHub Pages
          mkdir -p _site
          
          # Копіюємо всі файли HTML звіту (включаючи CSS, JS, дані)
          if [ -d "reports/html" ]; then
            cp -r reports/html/* _site/ || true
          fi
          
          # Знаходимо останній згенерований звіт та створюємо index.html
          # jest-html-reporters в CI генерує report-{timestamp}.html
          if [ -f "_site/report.html" ]; then
            # Якщо є простий report.html - використовуємо його
            cp _site/report.html _site/index.html
          else
            # Якщо є файли з timestamp (report-*.html), беремо останній
            LATEST_REPORT=$(ls -t _site/report-*.html 2>/dev/null | head -1)
            if [ -n "$LATEST_REPORT" ]; then
              cp "$LATEST_REPORT" _site/index.html
            fi
          fi
      
      # Крок 5: Завантаження артефакту для GitHub Pages
      # Створює артефакт з директорії _site для публікації
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site
      
      # Крок 6: Деплой на GitHub Pages
      # Публікує артефакт на GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
